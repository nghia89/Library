@model BiTech.Library.Models.PhieuNhapSachModels
@{
	ViewBag.Title = "Tạo phiếu nhập kho";
	Layout = "~/Views/Shared/_LayoutMain.cshtml";
}
<link href="~/bower_components/sweetalert/dist/sweetalert.css" rel="stylesheet" />

<script src="~/Scripts/angular-1.6.8/angular.min.js"></script>
<script src="~/Scripts/LibraryAngularJS.js"></script>

<div class="Title">Tạo Phiếu Nhập Kho</div>
<br />
<button type="button" class="btn btn-primary btn-sm" onclick="window.location='@Url.Action("Index", "PhieuNhapSach")'">
	<i class="fa fa-arrow-circle-left" style="padding-right: 4px;font-size: 17px;"></i>Trở lại
</button>
<hr />
<div ng-app="LibraryApp" class="clearfix">
	<div class="form-group">
		<div ng-cloak ng-controller="ImportBookCtrlr" class="">
			<div class="container-box-window clearfix">
				<div class="top">
					<span class="">Thông tin phiếu nhập</span>
				</div>
				<div class="content-box-window">
					@*<div class="form-group row">
							@Html.Label("Mã sách", new { @class = "col-md-2 control-label" })
							<div class="col-md-10">
								<input id="idSach" name="idSach" onkeydown="if (event.keyCode == 13) { return false; }" placeholder="Nhập mã sách" ng-model="maKS" class="form-control form-control-sm">
							</div>
						</div>*@

					@*VINH*@
					<div class="form-group row">
						@Html.Label("Mã sách", new { @class = "col-md-2 control-label" })
						<div class="col-sm-10">
							<div class="input-group mb-3">
								<input id="idSach" name="idSach"
									   onkeydown="if (event.keyCode == 13 || event.keyCode == 9) { EnterMaSach() }"
									   @*onfocusout="EnterMaSach()"*@
									   placeholder="Nhập mã sách" ng-model="maKS" class="form-control form-control-sm">
								<div class="input-group-append">
									<a href="@Url.Action("Create", "Sach")" target="_blank" class="btn btn-primary btn-sm" title="Tạo sách mới">
										<i class="fa fa-plus" style="line-height: 20px;"></i>
									</a>
								</div>
							</div>
						</div>
					</div>
					@*V*@

					<div class="form-group row">
						@Html.Label("Số lượng", new { @class = "col-md-2 control-label" })
						<div class="col-md-10">
							<input id="SoLuong" placeholder="Số lượng" ng-model="soLuong" class="form-control form-control-sm" type="number" autocomplete="off">
						</div>
					</div>

					<div class="form-group row">
						@Html.Label("Trạng thái sách", new { @class = "col-md-2 control-label" })
						<div class="col-md-10">
							@Html.DropDownList("TrangThai", new SelectList(ViewBag.listtt, "Id", "TenTT"), "--Chọn tình trạng--", new { ng_model = "idTrangThai", @class = "form-control form-control-sm" })
						</div>
					</div>

					<div class="form-group row">
						@*@Html.LabelFor(m => m.GhiChu, new { @class = "col-md-2 control-label" })*@
						<label class="col-md-2 control-label">Ghi chú sách</label>
						<div class="col-md-10">
							<textarea placeholder="Ghi chú" ng-model="GhiChuDon" class="form-control form-control-sm"></textarea>
						</div>
					</div>

					<div class="form-group row">
						<label class="col-md-2 control-label"></label>
						<div class="col-md-10">
							<input type="button" ng-click="addItem()" class="btn btn-sm btn-primary" value="Thêm">
						</div>
					</div>
				</div>
			</div>

			<br />

			<div class="container-box-window clearfix">
				<div class="top">
					<span class="">Danh sách sách nhập</span>
				</div>
				<div class="content-box-window">
					<div class="form-group row">
						<div class="danhsach-mt-sach-old col-md-12">
							<table class="table table-hover table-bordered mb-0" border="1">
								<thead>
									<tr class="table-info text-center">
										<th width="50">STT</th>
										<th width="15%">Mã kiểm soát</th>
										<th width="40%">Tên sách</th>
										<th width="10%">Trạng thái sách</th>
										<th width="10%">Số lượng</th>
										<th width="15%">Ghi chú sách</th>
										<th width="100" style="text-align: center;">
											<i class="fa fa-trash-o" title="Xoá tất cả" ng-click="ResetListBookQueue()" style="font-size:20px; cursor:pointer;"></i>
										</th>
									</tr>
								</thead>
								<tbody>
									<tr class="text-center" ng-repeat="x in list | orderBy : '-MaKiemSoat'" my-repeat-directive>
										<td align="center">{{$index + 1}}</td>
										<td>{{ x.MaKiemSoat }}</td>
										<td>{{ x.ten }}</td>
										<td>{{ x.tenTinhTrang }}</td>
										@*<td width="100px">{{x.soLuong}}</td>*@
										@*VINH*@
										<td width="100px">
											<div style="display: flex;">
												<div style="width:100%">
													<input type="number" ng-value="{{x.soLuong}}" id="List_{{x.MaKiemSoat}}_{{x.IdTinhTrang}}"
														   class="form-control form-control-sm"
														   min="1"
														   required oninput="this.value=this.value.replace(/[^0-9]/g,'');">
												</div>
											</div>
										</td>
										@*END VINH*@
										<td>{{x.GhiChuDon}}</td>
										<td align="center">
											<button ng-click="removeItem(x.MaKiemSoat, x.IdTinhTrang)" class="btn btn-sm btn-danger" style="cursor:pointer;float:none">×</button>
										</td>
									</tr>
								</tbody>
							</table>
						</div>

						@*<label class="col-md-2 control-label"></label>
							<div class="col-md-10">
								<div ng-repeat="s in list" id="lstItem">
									{{s.MaKiemSoat}} - {{s.ten}} - Số Lượng: {{s.soLuong}} - Tình Trạng: {{s.tenTinhTrang}} - Ghi Chú:{{s.GhiChuDon}}
									<button ng-click="removeItem($index)" class="btn btn-sm btn-danger" style="cursor:pointer;float:right">×</button><hr />
								</div>

								<div ng-repeat="s in list">
									<input hidden="hidden" ng-cloak class="btn btn-default" name="listChiTietJsonString" value="{{s}}" />
								</div>
							</div>*@
					</div>

					@using (Html.BeginForm("TaoPhieuNhapSach", "PhieuNhapSach", FormMethod.Post, new { @class = "form-horizontal", role = "form" }))
					{
						<div class="form-group row">
							<label class="col-md-2 control-label">Ghi chú phiếu nhập sách</label>
							<div class="col-md-10">
								<textarea name="GhiChu" placeholder="Ghi chú" ng-model="GhiChu" class="form-control form-control-sm"></textarea>
							</div>
						</div>

						<div ng-repeat="s in list">
							<input hidden="hidden" ng-cloak class="btn btn-default" name="listChiTietJsonString" value="{{s}}" />
						</div>

						<div class="form-group row">
							<div class="col-md-2"></div>
							<div class="col-md-offset-2 col-md-10">
								<input type="submit" class="btn btn-sm btn-primary" value="Tạo phiếu" />
								@*<input type="button" onclick="goBack()" class="btn btn-sm btn-default" value="Trở lại" />*@
							</div>
						</div>
					}
				</div>
			</div>
		</div>
	</div>
</div>

<div id="ajax"></div>

@section scripts{

	<script src="~/bower_components/jquery-ajax-unobtrusive/jquery.unobtrusive-ajax.min.js"></script>
	<script src="~/bower_components/jquery-validation/dist/jquery.validate.min.js"></script>
	<script src="~/bower_components/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
	<script src="~/bower_components/sweetalert/dist/sweetalert.min.js"></script>
	<script type="text/javascript" language="javascript">

        $("#idSach").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "/PhieuNhapSach/AutoComplete",
                    dataType: "json",
                    method: "post",
                    data: { a: request.term },
                    success: function (data) {
                        response($.map(data, function (item) {
                            return { label: item.MaKiemSoat, value: item.MaKiemSoat };
                        }))
                    }
                })
            },
            messages: {
                noResults: "", results: ""
            }
        });

        function EnterMaSach() {
            var idBook = $("#idSach").val();
            console.log(idBook);
			if (idBook == "") {
				alert('Chưa nhập mã sách');
				$("#idSach").focusout();
			}
            else {
                $.ajax({
                    type: "GET",
                    url: "@(Url.Action("GetBookByID", "PhieuNhapSach"))",
                    data: "idSach=" + idBook,
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data) {
                        console.log('Tim thay sach');
                        $("#idSach").val(data.MaKiemSoat);
                        $("#SoLuong").focus();
                    },
                    error: function () {
                        alert('Mã sách không tồn tại');
                        $("#idSach").val('');
                        console.log($("#idSach").val(""));
                    }
                });
            }
		}

		function RequestAltInsertGuiBegin() {
			$(this).addClass('active');
		}

		function RequestAltInsertGuiSuccess(data) {
			$(this).removeClass('active');

			//$("#ajax").html(data);

			$("#ajax").append(data);

			$("#edit-student-modal").modal();

			var form = $("#edit-student-modal").closest("form");
			form.removeData('validator');
			form.removeData('unobtrusiveValidation');
			$.validator.unobtrusive.parse(form);
		}
	</script>
}
